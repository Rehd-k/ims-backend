'use strict';const a69_0x367bea=a69_0x577d;(function(_0x222224,_0x2031c6){const _0x286659=a69_0x577d,_0x377151=_0x222224();while(!![]){try{const _0x166f22=parseInt(_0x286659(0xd7))/0x1+-parseInt(_0x286659(0x9d))/0x2+parseInt(_0x286659(0xb4))/0x3*(parseInt(_0x286659(0x99))/0x4)+-parseInt(_0x286659(0xcb))/0x5+-parseInt(_0x286659(0xfc))/0x6+parseInt(_0x286659(0xcc))/0x7*(parseInt(_0x286659(0xe0))/0x8)+parseInt(_0x286659(0x93))/0x9*(parseInt(_0x286659(0xe8))/0xa);if(_0x166f22===_0x2031c6)break;else _0x377151['push'](_0x377151['shift']());}catch(_0x38a48e){_0x377151['push'](_0x377151['shift']());}}}(a69_0x4141,0x66b8c));var __decorate=this&&this['__decorate']||function(_0x321f7a,_0x4d662d,_0x5d2bce,_0x3d584b){const _0x4a4194=a69_0x577d;var _0x5af86d=arguments[_0x4a4194(0xbf)],_0x49f3e2=_0x5af86d<0x3?_0x4d662d:_0x3d584b===null?_0x3d584b=Object[_0x4a4194(0x9c)](_0x4d662d,_0x5d2bce):_0x3d584b,_0x181afc;if(typeof Reflect==='object'&&typeof Reflect['decorate']===_0x4a4194(0xea))_0x49f3e2=Reflect[_0x4a4194(0xb9)](_0x321f7a,_0x4d662d,_0x5d2bce,_0x3d584b);else{for(var _0x7ff527=_0x321f7a['length']-0x1;_0x7ff527>=0x0;_0x7ff527--)if(_0x181afc=_0x321f7a[_0x7ff527])_0x49f3e2=(_0x5af86d<0x3?_0x181afc(_0x49f3e2):_0x5af86d>0x3?_0x181afc(_0x4d662d,_0x5d2bce,_0x49f3e2):_0x181afc(_0x4d662d,_0x5d2bce))||_0x49f3e2;}return _0x5af86d>0x3&&_0x49f3e2&&Object[_0x4a4194(0xdf)](_0x4d662d,_0x5d2bce,_0x49f3e2),_0x49f3e2;},__metadata=this&&this[a69_0x367bea(0xf3)]||function(_0x33dae1,_0x4bded7){const _0x50a025=a69_0x367bea;if(typeof Reflect===_0x50a025(0xcd)&&typeof Reflect[_0x50a025(0xa9)]===_0x50a025(0xea))return Reflect[_0x50a025(0xa9)](_0x33dae1,_0x4bded7);},__param=this&&this[a69_0x367bea(0xce)]||function(_0x542765,_0x4243f5){return function(_0x164772,_0x59983d){_0x4243f5(_0x164772,_0x59983d,_0x542765);};};function a69_0x4141(){const _0x223554=['findIndex','$totalExpiredQuantity','update','length','purchaseModel','amountPaid','editSoldQuantity','debt','splice','$$s.price','updating\x20one\x20purchases\x20error\x20','exec','findOne','getting\x20all\x20purchases\x20error\x20','mongoose','2278285KhaWuW','3542217CcoxFL','object','__param','$$s.amount','purchaseDate','status','name','expired','transfer','entries','$sold.amount','289368WErwyG','$totalSoldAmount','design:paramtypes','cash','save','$unitPrice','user','PurchasesService','defineProperty','8MDMXFG','_id','__esModule','../do_logger','push','quantity','InjectModel','./purchases.schema','360OlTjtm','setHours','function','increaseAmount','skip','limit','Failed\x20to\x20create\x20purchase\x20','getting\x20one\x20purchases\x20error\x20','Inject','productService','$sold','__metadata','stringify','$quantity','Record\x20Payment\x20error','endDate','findByIdAndDelete','recordPayment','supplier','createdAt','2402718rxmZHT','initiator','@nestjs/common','$$d.quantity','@nestjs/mongoose','forwardRef','parse','find','274698TJvGlT','sold','$damagedGoods.type','BadRequestException','expiryDate','username','411548TMaiHH','$damagedGoods.quantity','Purchase','getOwnPropertyDescriptor','1440440uUpYAP','$totalDamagedValue','startDate','keys','SupplierService','ERROR','ProductService','removeing\x20updating\x20sold\x20purchases\x20error\x20','forEach','removeing\x20one\x20purchases\x20error\x20','log','Order\x20not\x20found','metadata','deliveryDate','Injectable','create','addOrder','$totalExpiredValue','location','$totalSoldValue','aggregate','../product/product.service','$$d.type','3cjRhnY','amount','$damagedGoods','Failed\x20to\x20create\x20purchase','countDocuments','decorate','productId','findById'];a69_0x4141=function(){return _0x223554;};return a69_0x4141();}Object[a69_0x367bea(0xdf)](exports,a69_0x367bea(0xe2),{'value':!![]}),exports[a69_0x367bea(0xde)]=void 0x0;const common_1=require(a69_0x367bea(0xfe)),mongoose_1=require(a69_0x367bea(0x8f)),mongoose_2=require(a69_0x367bea(0xca)),purchases_schema_1=require(a69_0x367bea(0xe7)),supplier_service_1=require('../supplier/supplier.service'),product_service_1=require(a69_0x367bea(0xb2)),do_logger_1=require(a69_0x367bea(0xe3));let PurchasesService=class PurchasesService{constructor(_0x2f7fd3,_0x3253f5,_0x388384){const _0x232b71=a69_0x367bea;this[_0x232b71(0xc0)]=_0x2f7fd3,this['supplierService']=_0x3253f5,this[_0x232b71(0xf1)]=_0x388384;}async[a69_0x367bea(0xac)](_0x416c45,_0x33659d){const _0x4c08ac=a69_0x367bea;try{_0x416c45['location']=_0x33659d[_0x4c08ac(0xdd)]['location'],_0x416c45[_0x4c08ac(0xfd)]=_0x33659d[_0x4c08ac(0xdd)][_0x4c08ac(0x98)];const _0x2d19b7=new this[(_0x4c08ac(0xc0))](_0x416c45),_0x48398b=await _0x2d19b7[_0x4c08ac(0xdb)]();return await this[_0x4c08ac(0xf1)][_0x4c08ac(0xeb)](_0x2d19b7['productId'],_0x2d19b7['quantity']),await this['supplierService'][_0x4c08ac(0xad)](_0x2d19b7[_0x4c08ac(0xfa)],_0x48398b[_0x4c08ac(0xe1)]),_0x48398b;}catch(_0xef2a96){(0x0,do_logger_1[_0x4c08ac(0xa7)])(_0x4c08ac(0xee)+_0xef2a96,_0x4c08ac(0xa2));throw new common_1['BadRequestException'](_0x4c08ac(0xb7));}}async['getDashboardData'](_0x33213c){const _0x13d7b8=a69_0x367bea,_0x1e15d2=[{'$match':{'productId':_0x33213c}},{'$addFields':{'unitPrice':{'$cond':[{'$eq':['$quantity',0x0]},0x0,{'$divide':['$total',_0x13d7b8(0xf5)]}]},'totalSoldAmount':{'$sum':_0x13d7b8(0xd6)},'totalSoldValue':{'$sum':{'$map':{'input':_0x13d7b8(0xf2),'as':'s','in':{'$multiply':[_0x13d7b8(0xcf),_0x13d7b8(0xc5)]}}}},'totalDamagedQuantity':{'$cond':[{'$isArray':_0x13d7b8(0xb6)},{'$sum':_0x13d7b8(0x9a)},_0x13d7b8(0x9a)]},'totalDamagedValue':{'$cond':[{'$isArray':'$damagedGoods'},{'$sum':{'$map':{'input':_0x13d7b8(0xb6),'as':'d','in':{'$multiply':[_0x13d7b8(0xff),_0x13d7b8(0xdc)]}}}},{'$multiply':[_0x13d7b8(0x9a),_0x13d7b8(0xdc)]}]},'totalExpiredQuantity':{'$cond':[{'$isArray':'$damagedGoods'},{'$sum':{'$map':{'input':'$damagedGoods','as':'d','in':{'$cond':[{'$eq':[_0x13d7b8(0xb3),_0x13d7b8(0xd3)]},_0x13d7b8(0xff),0x0]}}}},{'$cond':[{'$eq':['$damagedGoods.type','expired']},_0x13d7b8(0x9a),0x0]}]},'totalExpiredValue':{'$cond':[{'$isArray':'$damagedGoods'},{'$sum':{'$map':{'input':_0x13d7b8(0xb6),'as':'d','in':{'$cond':[{'$eq':[_0x13d7b8(0xb3),_0x13d7b8(0xd3)]},{'$multiply':[_0x13d7b8(0xff),'$unitPrice']},0x0]}}}},{'$cond':[{'$eq':[_0x13d7b8(0x95),_0x13d7b8(0xd3)]},{'$multiply':['$damagedGoods.quantity',_0x13d7b8(0xdc)]},0x0]}]}}},{'$group':{'_id':null,'totalSales':{'$sum':_0x13d7b8(0xd8)},'totalSalesValue':{'$sum':_0x13d7b8(0xb0)},'totalPurchases':{'$sum':0x1},'totalPurchasesValue':{'$sum':{'$multiply':[_0x13d7b8(0xf5),_0x13d7b8(0xdc)]}},'totalProfit':{'$sum':{'$subtract':['$totalSoldValue',{'$multiply':[_0x13d7b8(0xd8),_0x13d7b8(0xdc)]}]}},'quantity':{'$sum':'$quantity'},'totalDamagedQuantity':{'$sum':'$totalDamagedQuantity'},'totalDamagedValue':{'$sum':_0x13d7b8(0x9e)},'totalExpiredQuantity':{'$sum':_0x13d7b8(0xbd)},'totalExpiredValue':{'$sum':_0x13d7b8(0xae)}}},{'$project':{'_id':0x0,'totalSales':0x1,'totalSalesValue':0x1,'totalPurchases':0x1,'totalPurchasesValue':0x1,'totalProfit':0x1,'quantity':0x1,'totalDamagedQuantity':0x1,'totalDamagedValue':0x1,'totalExpiredQuantity':0x1,'totalExpiredValue':0x1}}],_0x1b5d78=[{'totalSales':0x0,'totalSalesValue':0x0,'totalPurchases':0x0,'totalPurchasesValue':0x0,'totalProfit':0x0,'quantity':0x0,'totalDamagedQuantity':0x0,'totalDamagedValue':0x0,'totalExpiredQuantity':0x0,'totalExpiredValue':0x0}],_0x3cadaf=await this[_0x13d7b8(0xc0)][_0x13d7b8(0xb1)](_0x1e15d2)[_0x13d7b8(0xc7)]();if(_0x3cadaf[_0x13d7b8(0xbf)]===0x0)return _0x1b5d78;return _0x3cadaf;}async[a69_0x367bea(0xf9)](_0x1f633b,_0xf1a385){const _0x2457ba=a69_0x367bea;try{const _0x515c2d=await this[_0x2457ba(0xc0)][_0x2457ba(0xbb)](_0x1f633b);if(!_0x515c2d)throw new common_1['BadRequestException'](_0x2457ba(0xa8));_0x515c2d['outStandingPayments'][_0x2457ba(0xe4)](_0xf1a385);let _0x2e1ca7=_0xf1a385[_0x2457ba(0xc1)]['card']+_0xf1a385[_0x2457ba(0xc1)][_0x2457ba(0xda)]+_0xf1a385['amountPaid'][_0x2457ba(0xd4)];return _0x515c2d[_0x2457ba(0xc3)]=_0x515c2d[_0x2457ba(0xc3)]-_0x2e1ca7,_0x515c2d[_0x2457ba(0xdb)]();}catch(_0x3569a3){(0x0,do_logger_1[_0x2457ba(0xa7)])('Record\x20Payment\x20error\x20'+_0x3569a3,_0x2457ba(0xa2));throw new common_1[(_0x2457ba(0x96))](_0x2457ba(0xf6));}}async['findAll'](_0x385315,_0x9fd8fb){const _0x3d2cbc=a69_0x367bea,{filter:filter='{}',sort:sort='{}',skip:skip=0x0,select:select='',limit:limit=0xa}=_0x385315;try{const _0x288cfd=JSON[_0x3d2cbc(0x91)](filter),_0x1807d2=JSON[_0x3d2cbc(0x91)](sort),_0x133ef3=Object[_0x3d2cbc(0xa0)](_0x288cfd),_0x1b7f3c=new Date(_0x385315[_0x3d2cbc(0x9f)]);_0x1b7f3c[_0x3d2cbc(0xe9)](0x0,0x0,0x0,0x0);const _0x3cd851=new Date(_0x385315[_0x3d2cbc(0xf7)]);_0x3cd851[_0x3d2cbc(0xe9)](0x17,0x3b,0x3b,0x3e7),_0x133ef3[_0x3d2cbc(0xa5)](_0x1d49be=>{const _0x2fcc29=_0x3d2cbc;if(_0x1d49be==_0x2fcc29(0xfb))_0x288cfd[_0x1d49be]={'$gte':_0x1b7f3c,'$lte':_0x3cd851};else{if(_0x1d49be==_0x2fcc29(0x97))_0x288cfd[_0x1d49be]={'$gte':_0x1b7f3c,'$lte':_0x3cd851};else{if(_0x1d49be==_0x2fcc29(0xd0))_0x288cfd[_0x1d49be]={'$gte':_0x1b7f3c,'$lte':_0x3cd851};else _0x1d49be==_0x2fcc29(0xaa)&&(_0x288cfd[_0x1d49be]={'$gte':_0x1b7f3c,'$lte':_0x3cd851});}}});_0x288cfd[_0x3d2cbc(0xfa)]===''&&(delete _0x288cfd[_0x3d2cbc(0xfa)],delete _0x288cfd[_0x3d2cbc(0xd1)]);_0x288cfd[_0x3d2cbc(0xd1)]===''&&delete _0x288cfd[_0x3d2cbc(0xd1)];const _0x4ea4fa=await this[_0x3d2cbc(0xc0)][_0x3d2cbc(0x92)]({..._0x288cfd,'location':_0x9fd8fb[_0x3d2cbc(0xdd)][_0x3d2cbc(0xaf)]})['sort'](_0x1807d2)[_0x3d2cbc(0xed)](Number(limit))[_0x3d2cbc(0xec)](Number(skip))['select'](''+select)['populate']({'path':_0x3d2cbc(0xfa),'select':_0x3d2cbc(0xd2)})[_0x3d2cbc(0xc7)](),_0x1b4a9c=await this['purchaseModel'][_0x3d2cbc(0xb8)]({..._0x288cfd,'location':_0x9fd8fb[_0x3d2cbc(0xdd)][_0x3d2cbc(0xaf)]});return{'purchases':_0x4ea4fa,'totalDocuments':_0x1b4a9c};}catch(_0x104650){(0x0,do_logger_1[_0x3d2cbc(0xa7)])(_0x3d2cbc(0xc9)+_0x104650,_0x3d2cbc(0xa2));throw new common_1[(_0x3d2cbc(0x96))](_0x104650);}}async[a69_0x367bea(0xc8)](_0x48d327){const _0x44530e=a69_0x367bea;try{return this[_0x44530e(0xc0)][_0x44530e(0xbb)](_0x48d327)['exec']();}catch(_0x59f907){(0x0,do_logger_1[_0x44530e(0xa7)])(_0x44530e(0xef)+_0x59f907,_0x44530e(0xa2));throw new common_1[(_0x44530e(0x96))](_0x59f907);}}async[a69_0x367bea(0xbe)](_0x3ff885,_0x1075a8){const _0x9e74ef=a69_0x367bea;try{Object[_0x9e74ef(0xd5)](_0x1075a8)['forEach'](([_0x395232,_0x30e84c])=>{const _0x13f308=_0x9e74ef;(0x0,do_logger_1['log'])(_0x395232+':\x20'+JSON[_0x13f308(0xf4)](_0x30e84c));});const _0x57959e=await this[_0x9e74ef(0xf1)][_0x9e74ef(0xc8)](_0x1075a8['productId']);_0x57959e[_0x9e74ef(0xe5)]=_0x57959e['quantity']-Number(_0x1075a8['quantity']);const _0x3d6521=await this[_0x9e74ef(0xc0)][_0x9e74ef(0xbb)](_0x3ff885);_0x3d6521['quantity']=_0x3d6521[_0x9e74ef(0xe5)]-Number(_0x1075a8[_0x9e74ef(0xe5)]),delete _0x1075a8[_0x9e74ef(0xba)],delete _0x1075a8[_0x9e74ef(0xe1)],_0x3d6521['damagedGoods'][_0x9e74ef(0xe4)](_0x1075a8),await _0x57959e['save'](),await _0x3d6521[_0x9e74ef(0xdb)]();}catch(_0x3c6354){(0x0,do_logger_1[_0x9e74ef(0xa7)])(_0x9e74ef(0xc6)+_0x3c6354,'ERROR');throw new common_1[(_0x9e74ef(0x96))](_0x3c6354);}}async['remove'](_0x5af30c){const _0x70d327=a69_0x367bea;try{return this[_0x70d327(0xc0)][_0x70d327(0xf8)](_0x5af30c)[_0x70d327(0xc7)]();}catch(_0x94c29f){(0x0,do_logger_1[_0x70d327(0xa7)])(_0x70d327(0xa6)+_0x94c29f,'ERROR');throw new common_1['BadRequestException'](_0x94c29f);}}async[a69_0x367bea(0xc2)](_0xddd12c,_0x4aced7,_0x4cd972){const _0x1ead26=a69_0x367bea;try{const _0x3afbde=await this['purchaseModel'][_0x1ead26(0xbb)](_0xddd12c),_0x5c722b=_0x3afbde[_0x1ead26(0x94)][_0x1ead26(0xbc)](_0x181c7a=>_0x181c7a['price']==_0x4cd972);return _0x3afbde[_0x1ead26(0x94)][_0x5c722b][_0x1ead26(0xb5)]-=_0x4aced7,_0x3afbde[_0x1ead26(0x94)][_0x5c722b][_0x1ead26(0xb5)]<0x1&&_0x3afbde[_0x1ead26(0x94)][_0x1ead26(0xc4)](_0x5c722b,0x1),await _0x3afbde[_0x1ead26(0xdb)](),_0x3afbde;}catch(_0x3f8f3d){(0x0,do_logger_1['log'])(_0x1ead26(0xa4)+_0x3f8f3d,'ERROR');throw new common_1[(_0x1ead26(0x96))](_0x3f8f3d);}}async['findFirstUnsoldPurchase'](_0x4c0361,_0x1b0c7f){const _0xe3bbf6=a69_0x367bea;try{const _0x111a7a=await this[_0xe3bbf6(0xc0)][_0xe3bbf6(0xc8)]({'productId':_0x4c0361,'$expr':{'$lt':[{'$sum':_0xe3bbf6(0xd6)},_0xe3bbf6(0xf5)]},'location':_0x1b0c7f[_0xe3bbf6(0xdd)][_0xe3bbf6(0xaf)]})['sort']({'createdAt':0x1})[_0xe3bbf6(0xc7)]();return _0x111a7a;}catch(_0x3f8625){(0x0,do_logger_1[_0xe3bbf6(0xa7)])(''+_0x3f8625,_0xe3bbf6(0xa2));throw new common_1[(_0xe3bbf6(0x96))](_0x3f8625);}}};function a69_0x577d(_0x5edffa,_0x21f446){const _0x414122=a69_0x4141();return a69_0x577d=function(_0x577d45,_0xe1aff8){_0x577d45=_0x577d45-0x8f;let _0x2e6ca0=_0x414122[_0x577d45];return _0x2e6ca0;},a69_0x577d(_0x5edffa,_0x21f446);}exports[a69_0x367bea(0xde)]=PurchasesService,exports['PurchasesService']=PurchasesService=__decorate([(0x0,common_1[a69_0x367bea(0xab)])(),__param(0x0,(0x0,mongoose_1[a69_0x367bea(0xe6)])(purchases_schema_1[a69_0x367bea(0x9b)]['name'])),__param(0x2,(0x0,common_1[a69_0x367bea(0xf0)])((0x0,common_1[a69_0x367bea(0x90)])(()=>product_service_1['ProductService']))),__metadata(a69_0x367bea(0xd9),[mongoose_2['Model'],supplier_service_1[a69_0x367bea(0xa1)],product_service_1[a69_0x367bea(0xa3)]])],PurchasesService);