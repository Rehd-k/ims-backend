'use strict';const a70_0x144357=a70_0xf26a;(function(_0x12a8e8,_0x12b243){const _0x88f894=a70_0xf26a,_0x590193=_0x12a8e8();while(!![]){try{const _0x4e79b9=parseInt(_0x88f894(0xff))/0x1+parseInt(_0x88f894(0x124))/0x2*(-parseInt(_0x88f894(0x106))/0x3)+-parseInt(_0x88f894(0x12c))/0x4+-parseInt(_0x88f894(0x10c))/0x5+-parseInt(_0x88f894(0x113))/0x6+parseInt(_0x88f894(0x139))/0x7+parseInt(_0x88f894(0x13e))/0x8;if(_0x4e79b9===_0x12b243)break;else _0x590193['push'](_0x590193['shift']());}catch(_0x1bd115){_0x590193['push'](_0x590193['shift']());}}}(a70_0x2d9e,0x51018));var __decorate=this&&this['__decorate']||function(_0xdc576a,_0x28bb50,_0x54ac98,_0x3fc671){const _0x75784d=a70_0xf26a,_0x203113={'RqvXb':function(_0x271384,_0x472110){return _0x271384<_0x472110;},'bXJBu':function(_0x572706,_0x410279){return _0x572706===_0x410279;},'GwwnR':'object','jdGqL':function(_0x474258,_0x526839){return _0x474258===_0x526839;},'YrzyS':function(_0x390801,_0x1740ec){return _0x390801-_0x1740ec;}};var _0x542adc=arguments['length'],_0x4e16be=_0x203113[_0x75784d(0x147)](_0x542adc,0x3)?_0x28bb50:_0x203113[_0x75784d(0x103)](_0x3fc671,null)?_0x3fc671=Object[_0x75784d(0x12f)](_0x28bb50,_0x54ac98):_0x3fc671,_0x333f61;if(typeof Reflect===_0x203113['GwwnR']&&_0x203113['jdGqL'](typeof Reflect['decorate'],_0x75784d(0x125)))_0x4e16be=Reflect[_0x75784d(0x107)](_0xdc576a,_0x28bb50,_0x54ac98,_0x3fc671);else{for(var _0x16245c=_0x203113[_0x75784d(0xfc)](_0xdc576a[_0x75784d(0x128)],0x1);_0x16245c>=0x0;_0x16245c--)if(_0x333f61=_0xdc576a[_0x16245c])_0x4e16be=(_0x203113['RqvXb'](_0x542adc,0x3)?_0x333f61(_0x4e16be):_0x542adc>0x3?_0x333f61(_0x28bb50,_0x54ac98,_0x4e16be):_0x333f61(_0x28bb50,_0x54ac98))||_0x4e16be;}return _0x542adc>0x3&&_0x4e16be&&Object[_0x75784d(0x135)](_0x28bb50,_0x54ac98,_0x4e16be),_0x4e16be;},__metadata=this&&this['__metadata']||function(_0xec84f7,_0x6c5992){const _0x1943c2=a70_0xf26a;if(typeof Reflect===_0x1943c2(0x146)&&typeof Reflect['metadata']===_0x1943c2(0x125))return Reflect['metadata'](_0xec84f7,_0x6c5992);},__param=this&&this[a70_0x144357(0x10e)]||function(_0x4b8f1a,_0x465bd6){const _0x355aec={'HrRWM':function(_0x196fba,_0x42b592,_0x4b57fd,_0x1bbb77){return _0x196fba(_0x42b592,_0x4b57fd,_0x1bbb77);}};return function(_0x4e9dc9,_0x17f731){const _0x23cc90=a70_0xf26a;_0x355aec[_0x23cc90(0x13f)](_0x465bd6,_0x4e9dc9,_0x17f731,_0x4b8f1a);};};Object[a70_0x144357(0x135)](exports,a70_0x144357(0x12b),{'value':!![]}),exports[a70_0x144357(0x118)]=void 0x0;const common_1=require(a70_0x144357(0x11e)),mongoose_1=require('@nestjs/mongoose'),mongoose_2=require('mongoose'),purchases_schema_1=require('./purchases.schema'),supplier_service_1=require('../supplier/supplier.service'),product_service_1=require('../product/product.service'),do_logger_1=require(a70_0x144357(0x127));function a70_0xf26a(_0xb23386,_0x16221a){const _0x2d9e12=a70_0x2d9e();return a70_0xf26a=function(_0xf26a95,_0x19f519){_0xf26a95=_0xf26a95-0xea;let _0x291520=_0x2d9e12[_0xf26a95];return _0x291520;},a70_0xf26a(_0xb23386,_0x16221a);}let PurchasesService=class PurchasesService{constructor(_0xcd8dc4,_0x530a06,_0xeb57b1){const _0x5d9a4c=a70_0x144357;this['purchaseModel']=_0xcd8dc4,this['supplierService']=_0x530a06,this[_0x5d9a4c(0x13b)]=_0xeb57b1;}async[a70_0x144357(0x121)](_0xf3b8c9,_0xbf4641){const _0x5e92af=a70_0x144357,_0x1939aa={'dGJXU':_0x5e92af(0xed)};try{_0xf3b8c9['location']=_0xbf4641['user']['location'],_0xf3b8c9['initiator']=_0xbf4641[_0x5e92af(0x123)][_0x5e92af(0xf5)];const _0x4d176d=new this['purchaseModel'](_0xf3b8c9),_0x1aa5b0=await _0x4d176d[_0x5e92af(0x13d)]();return await this[_0x5e92af(0x13b)]['increaseAmount'](_0x4d176d['productId'],_0x4d176d['quantity']),await this['supplierService'][_0x5e92af(0x13a)](_0x4d176d['supplier'],_0x1aa5b0[_0x5e92af(0xf9)]),_0x1aa5b0;}catch(_0x2a2f1c){(0x0,do_logger_1[_0x5e92af(0xf1)])(_0x5e92af(0x101)+_0x2a2f1c,_0x1939aa[_0x5e92af(0xf3)]);throw new common_1['BadRequestException'](_0x5e92af(0x137));}}async['getDashboardData'](_0xc81e12){const _0x14e1a9=a70_0x144357,_0x17c0db={'bhDBV':'$sold.amount','mIsJs':_0x14e1a9(0x111),'aXjix':_0x14e1a9(0x144),'dOGLm':_0x14e1a9(0x11d),'AxqiS':'$unitPrice','ISNzQ':'$totalSoldAmount','URjAx':'$totalSoldValue','CTQYm':'$totalDamagedValue','VGWtL':function(_0x1501d9,_0x431ab1){return _0x1501d9===_0x431ab1;}},_0x1eddd5=[{'$match':{'productId':_0xc81e12}},{'$addFields':{'unitPrice':{'$cond':[{'$eq':[_0x14e1a9(0x10d),0x0]},0x0,{'$divide':['$total',_0x14e1a9(0x10d)]}]},'totalSoldAmount':{'$sum':_0x17c0db[_0x14e1a9(0xf4)]},'totalSoldValue':{'$sum':{'$map':{'input':'$sold','as':'s','in':{'$multiply':[_0x14e1a9(0xef),'$$s.price']}}}},'totalDamagedQuantity':{'$cond':[{'$isArray':_0x14e1a9(0x11d)},{'$sum':_0x14e1a9(0x144)},_0x14e1a9(0x144)]},'totalDamagedValue':{'$cond':[{'$isArray':'$damagedGoods'},{'$sum':{'$map':{'input':_0x14e1a9(0x11d),'as':'d','in':{'$multiply':[_0x17c0db[_0x14e1a9(0x11f)],'$unitPrice']}}}},{'$multiply':[_0x17c0db[_0x14e1a9(0xfe)],_0x14e1a9(0x131)]}]},'totalExpiredQuantity':{'$cond':[{'$isArray':'$damagedGoods'},{'$sum':{'$map':{'input':_0x17c0db['dOGLm'],'as':'d','in':{'$cond':[{'$eq':['$$d.type',_0x14e1a9(0x145)]},_0x17c0db[_0x14e1a9(0x11f)],0x0]}}}},{'$cond':[{'$eq':['$damagedGoods.type',_0x14e1a9(0x145)]},'$damagedGoods.quantity',0x0]}]},'totalExpiredValue':{'$cond':[{'$isArray':'$damagedGoods'},{'$sum':{'$map':{'input':'$damagedGoods','as':'d','in':{'$cond':[{'$eq':[_0x14e1a9(0xf7),'expired']},{'$multiply':[_0x14e1a9(0x111),_0x17c0db['AxqiS']]},0x0]}}}},{'$cond':[{'$eq':['$damagedGoods.type',_0x14e1a9(0x145)]},{'$multiply':[_0x17c0db['aXjix'],_0x14e1a9(0x131)]},0x0]}]}}},{'$group':{'_id':null,'totalSales':{'$sum':_0x17c0db['ISNzQ']},'totalSalesValue':{'$sum':_0x17c0db['URjAx']},'totalPurchases':{'$sum':0x1},'totalPurchasesValue':{'$sum':{'$multiply':['$quantity',_0x14e1a9(0x131)]}},'totalProfit':{'$sum':{'$subtract':['$totalSoldValue',{'$multiply':[_0x14e1a9(0xea),_0x17c0db['AxqiS']]}]}},'quantity':{'$sum':_0x14e1a9(0x10d)},'totalDamagedQuantity':{'$sum':_0x14e1a9(0x116)},'totalDamagedValue':{'$sum':_0x17c0db[_0x14e1a9(0x142)]},'totalExpiredQuantity':{'$sum':'$totalExpiredQuantity'},'totalExpiredValue':{'$sum':'$totalExpiredValue'}}},{'$project':{'_id':0x0,'totalSales':0x1,'totalSalesValue':0x1,'totalPurchases':0x1,'totalPurchasesValue':0x1,'totalProfit':0x1,'quantity':0x1,'totalDamagedQuantity':0x1,'totalDamagedValue':0x1,'totalExpiredQuantity':0x1,'totalExpiredValue':0x1}}],_0x2ec8fc=[{'totalSales':0x0,'totalSalesValue':0x0,'totalPurchases':0x0,'totalPurchasesValue':0x0,'totalProfit':0x0,'quantity':0x0,'totalDamagedQuantity':0x0,'totalDamagedValue':0x0,'totalExpiredQuantity':0x0,'totalExpiredValue':0x0}],_0x39d940=await this[_0x14e1a9(0x102)][_0x14e1a9(0x12d)](_0x1eddd5)['exec']();if(_0x17c0db['VGWtL'](_0x39d940['length'],0x0))return _0x2ec8fc;return _0x39d940;}async['recordPayment'](_0x283889,_0x470c18){const _0x100b1d=a70_0x144357,_0x4d2b5a={'AWULn':function(_0x29d9aa,_0x2cdf69){return _0x29d9aa+_0x2cdf69;},'kreUH':function(_0x44dea8,_0x26b2dd){return _0x44dea8+_0x26b2dd;},'sjdSD':_0x100b1d(0x141)};try{const _0x3995bc=await this[_0x100b1d(0x102)]['findById'](_0x283889);if(!_0x3995bc)throw new common_1[(_0x100b1d(0x134))](_0x100b1d(0xec));_0x3995bc[_0x100b1d(0x10b)]['push'](_0x470c18);let _0xc212c=_0x4d2b5a['AWULn'](_0x4d2b5a[_0x100b1d(0x112)](_0x470c18['amountPaid'][_0x100b1d(0x12a)],_0x470c18['amountPaid']['cash']),_0x470c18[_0x100b1d(0x100)][_0x100b1d(0x11c)]);return _0x3995bc[_0x100b1d(0xfd)]=_0x3995bc[_0x100b1d(0xfd)]-_0xc212c,_0x3995bc['save']();}catch(_0x587db1){(0x0,do_logger_1[_0x100b1d(0xf1)])('Record\x20Payment\x20error\x20'+_0x587db1,_0x100b1d(0xed));throw new common_1[(_0x100b1d(0x134))](_0x4d2b5a[_0x100b1d(0xfb)]);}}async['findAll'](_0x569042,_0x3b2590){const _0x3acad3=a70_0x144357,_0x2992d5={'LGWOS':function(_0x6faa37,_0x2af464){return _0x6faa37==_0x2af464;},'PIZhh':function(_0x181263,_0x44cc36){return _0x181263(_0x44cc36);},'wEUnN':_0x3acad3(0x110),'wCvej':'ERROR'},{filter:filter='{}',sort:sort='{}',skip:skip=0x0,select:select='',limit:limit=0xa}=_0x569042;try{const _0x4cd19a=JSON[_0x3acad3(0xf2)](filter),_0x45e9b2=JSON['parse'](sort),_0x158c5f=Object[_0x3acad3(0x132)](_0x4cd19a),_0x222fc3=new Date(_0x569042['startDate']);_0x222fc3['setHours'](0x0,0x0,0x0,0x0);const _0x4b7f2a=new Date(_0x569042['endDate']);_0x4b7f2a['setHours'](0x17,0x3b,0x3b,0x3e7),_0x158c5f['forEach'](_0x55a935=>{const _0x5a0047=_0x3acad3;if(_0x2992d5[_0x5a0047(0x130)](_0x55a935,'createdAt'))_0x4cd19a[_0x55a935]={'$gte':_0x222fc3,'$lte':_0x4b7f2a};else{if(_0x55a935==_0x5a0047(0x119))_0x4cd19a[_0x55a935]={'$gte':_0x222fc3,'$lte':_0x4b7f2a};else{if(_0x55a935==_0x5a0047(0x122))_0x4cd19a[_0x55a935]={'$gte':_0x222fc3,'$lte':_0x4b7f2a};else _0x2992d5[_0x5a0047(0x130)](_0x55a935,'deliveryDate')&&(_0x4cd19a[_0x55a935]={'$gte':_0x222fc3,'$lte':_0x4b7f2a});}}});_0x4cd19a['supplier']===''&&(delete _0x4cd19a['supplier'],delete _0x4cd19a['status']);_0x4cd19a[_0x3acad3(0x129)]===''&&delete _0x4cd19a['status'];const _0x4141b8=await this['purchaseModel'][_0x3acad3(0xf0)]({..._0x4cd19a,'location':_0x3b2590[_0x3acad3(0x123)][_0x3acad3(0xf8)]})['sort'](_0x45e9b2)['limit'](Number(limit))['skip'](_0x2992d5[_0x3acad3(0x11a)](Number,skip))['select'](''+select)[_0x3acad3(0x120)]({'path':_0x2992d5['wEUnN'],'select':_0x3acad3(0x140)})['exec'](),_0x1a49d6=await this[_0x3acad3(0x102)][_0x3acad3(0x11b)]({..._0x4cd19a,'location':_0x3b2590['user']['location']});return{'purchases':_0x4141b8,'totalDocuments':_0x1a49d6};}catch(_0x14a40a){(0x0,do_logger_1[_0x3acad3(0xf1)])('getting\x20all\x20purchases\x20error\x20'+_0x14a40a,_0x2992d5[_0x3acad3(0xf6)]);throw new common_1['BadRequestException'](_0x14a40a);}}async['findOne'](_0x48f17f){const _0x493ea6=a70_0x144357,_0x10c2f1={'jXacc':'ERROR'};try{return this[_0x493ea6(0x102)]['findById'](_0x48f17f)[_0x493ea6(0x117)]();}catch(_0x32c58f){(0x0,do_logger_1[_0x493ea6(0xf1)])(_0x493ea6(0x10f)+_0x32c58f,_0x10c2f1['jXacc']);throw new common_1[(_0x493ea6(0x134))](_0x32c58f);}}async['update'](_0x5eeebb,_0x31da5a){const _0xbad678=a70_0x144357,_0x5bcc8d={'yGjcU':function(_0x4469e5,_0x2f1ce9){return _0x4469e5(_0x2f1ce9);}};try{Object[_0xbad678(0x136)](_0x31da5a)[_0xbad678(0x133)](([_0x5147ba,_0x27ec80])=>{(0x0,do_logger_1['log'])(_0x5147ba+':\x20'+JSON['stringify'](_0x27ec80));});const _0x36913d=await this['productService'][_0xbad678(0x114)](_0x31da5a[_0xbad678(0x138)]);_0x36913d['quantity']=_0x36913d[_0xbad678(0x12e)]-Number(_0x31da5a[_0xbad678(0x12e)]);const _0x5c2842=await this[_0xbad678(0x102)][_0xbad678(0x105)](_0x5eeebb);_0x5c2842[_0xbad678(0x12e)]=_0x5c2842['quantity']-_0x5bcc8d['yGjcU'](Number,_0x31da5a[_0xbad678(0x12e)]),delete _0x31da5a[_0xbad678(0x138)],delete _0x31da5a[_0xbad678(0xf9)],_0x5c2842['damagedGoods']['push'](_0x31da5a),await _0x36913d['save'](),await _0x5c2842[_0xbad678(0x13d)]();}catch(_0x2aa262){(0x0,do_logger_1[_0xbad678(0xf1)])('updating\x20one\x20purchases\x20error\x20'+_0x2aa262,'ERROR');throw new common_1['BadRequestException'](_0x2aa262);}}async[a70_0x144357(0x10a)](_0x2d1da4){const _0x549d08=a70_0x144357,_0x3b8552={'fWuME':_0x549d08(0xed)};try{return this['purchaseModel']['findByIdAndDelete'](_0x2d1da4)[_0x549d08(0x117)]();}catch(_0x2d8712){(0x0,do_logger_1['log'])(_0x549d08(0x108)+_0x2d8712,_0x3b8552['fWuME']);throw new common_1[(_0x549d08(0x134))](_0x2d8712);}}async['editSoldQuantity'](_0x1d9cf9,_0x177d0b,_0x191a92){const _0x18740c=a70_0x144357;try{const _0x33a7df=await this['purchaseModel'][_0x18740c(0x105)](_0x1d9cf9),_0xd843ef=_0x33a7df[_0x18740c(0x104)]['findIndex'](_0x41b1cb=>_0x41b1cb[_0x18740c(0x115)]==_0x191a92);return _0x33a7df[_0x18740c(0x104)][_0xd843ef]['amount']-=_0x177d0b,_0x33a7df['sold'][_0xd843ef][_0x18740c(0x126)]<0x1&&_0x33a7df['sold']['splice'](_0xd843ef,0x1),await _0x33a7df[_0x18740c(0x13d)](),_0x33a7df;}catch(_0x3aebc4){(0x0,do_logger_1[_0x18740c(0xf1)])(_0x18740c(0x143)+_0x3aebc4,'ERROR');throw new common_1['BadRequestException'](_0x3aebc4);}}async['findFirstUnsoldPurchase'](_0x1a7ec3,_0x538d91){const _0x148d0f=a70_0x144357,_0x2f0bed={'puVUq':'$sold.amount'};try{const _0x5da246=await this[_0x148d0f(0x102)]['findOne']({'productId':_0x1a7ec3,'$expr':{'$lt':[{'$sum':_0x2f0bed[_0x148d0f(0xfa)]},'$quantity']},'location':_0x538d91['user']['location']})[_0x148d0f(0xee)]({'createdAt':0x1})[_0x148d0f(0x117)]();return _0x5da246;}catch(_0xdd023a){(0x0,do_logger_1[_0x148d0f(0xf1)])(''+_0xdd023a,_0x148d0f(0xed));throw new common_1[(_0x148d0f(0x134))](_0xdd023a);}}};exports['PurchasesService']=PurchasesService,exports['PurchasesService']=PurchasesService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,mongoose_1[a70_0x144357(0x109)])(purchases_schema_1['Purchase']['name'])),__param(0x2,(0x0,common_1['Inject'])((0x0,common_1['forwardRef'])(()=>product_service_1['ProductService']))),__metadata(a70_0x144357(0x13c),[mongoose_2['Model'],supplier_service_1[a70_0x144357(0xeb)],product_service_1['ProductService']])],PurchasesService);function a70_0x2d9e(){const _0x5872a1=['findOne','price','$totalDamagedQuantity','exec','PurchasesService','expiryDate','PIZhh','countDocuments','transfer','$damagedGoods','@nestjs/common','mIsJs','populate','create','purchaseDate','user','2yZXarY','function','amount','../do_logger','length','status','card','__esModule','2282372PPMOQW','aggregate','quantity','getOwnPropertyDescriptor','LGWOS','$unitPrice','keys','forEach','BadRequestException','defineProperty','entries','Failed\x20to\x20create\x20purchase','productId','4429166chIvBb','addOrder','productService','design:paramtypes','save','8360792QEGScH','HrRWM','name','Record\x20Payment\x20error','CTQYm','removeing\x20updating\x20sold\x20purchases\x20error\x20','$damagedGoods.quantity','expired','object','RqvXb','$totalSoldAmount','SupplierService','Order\x20not\x20found','ERROR','sort','$$s.amount','find','log','parse','dGJXU','bhDBV','username','wCvej','$$d.type','location','_id','puVUq','sjdSD','YrzyS','debt','aXjix','111171PfqFXU','amountPaid','Failed\x20to\x20create\x20purchase\x20','purchaseModel','bXJBu','sold','findById','1210662etciGh','decorate','removeing\x20one\x20purchases\x20error\x20','InjectModel','remove','outStandingPayments','2075705YPpIdW','$quantity','__param','getting\x20one\x20purchases\x20error\x20','supplier','$$d.quantity','kreUH','407520VsDNwQ'];a70_0x2d9e=function(){return _0x5872a1;};return a70_0x2d9e();}