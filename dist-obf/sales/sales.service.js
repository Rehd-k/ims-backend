'use strict';const a74_0xb2d391=a74_0x7617;(function(_0x2f7ce2,_0x4b33ea){const _0x5b04be=a74_0x7617,_0x2ac01e=_0x2f7ce2();while(!![]){try{const _0x289f93=parseInt(_0x5b04be(0x225))/0x1*(parseInt(_0x5b04be(0x1d5))/0x2)+-parseInt(_0x5b04be(0x1d9))/0x3*(parseInt(_0x5b04be(0x210))/0x4)+parseInt(_0x5b04be(0x22b))/0x5*(parseInt(_0x5b04be(0x1db))/0x6)+-parseInt(_0x5b04be(0x1e6))/0x7*(-parseInt(_0x5b04be(0x237))/0x8)+parseInt(_0x5b04be(0x20f))/0x9+-parseInt(_0x5b04be(0x1c6))/0xa*(parseInt(_0x5b04be(0x220))/0xb)+parseInt(_0x5b04be(0x232))/0xc*(-parseInt(_0x5b04be(0x207))/0xd);if(_0x289f93===_0x4b33ea)break;else _0x2ac01e['push'](_0x2ac01e['shift']());}catch(_0x49fb0f){_0x2ac01e['push'](_0x2ac01e['shift']());}}}(a74_0x2699,0x41a58));function a74_0x7617(_0x5f5477,_0x57d3c5){const _0x269971=a74_0x2699();return a74_0x7617=function(_0x76170a,_0x1b28a6){_0x76170a=_0x76170a-0x1bd;let _0x2eddb9=_0x269971[_0x76170a];return _0x2eddb9;},a74_0x7617(_0x5f5477,_0x57d3c5);}var __decorate=this&&this[a74_0xb2d391(0x1f1)]||function(_0x2e479d,_0xebeb19,_0x470997,_0x348b84){const _0x59c37b=a74_0xb2d391,_0x1ebe12={'pKIbS':_0x59c37b(0x212),'bAVWB':function(_0x5f25df,_0x4bcc68){return _0x5f25df>=_0x4bcc68;},'QqDpw':function(_0x1d010e,_0x31a1cd){return _0x1d010e(_0x31a1cd);},'uXPvU':function(_0x3b35fa,_0x137e02){return _0x3b35fa>_0x137e02;}};var _0x1634a4=arguments[_0x59c37b(0x236)],_0x5ab37a=_0x1634a4<0x3?_0xebeb19:_0x348b84===null?_0x348b84=Object[_0x59c37b(0x1be)](_0xebeb19,_0x470997):_0x348b84,_0x4f2199;if(typeof Reflect===_0x1ebe12[_0x59c37b(0x1ca)]&&typeof Reflect[_0x59c37b(0x1f9)]===_0x59c37b(0x21a))_0x5ab37a=Reflect['decorate'](_0x2e479d,_0xebeb19,_0x470997,_0x348b84);else{for(var _0x3c00ad=_0x2e479d[_0x59c37b(0x236)]-0x1;_0x1ebe12[_0x59c37b(0x1ee)](_0x3c00ad,0x0);_0x3c00ad--)if(_0x4f2199=_0x2e479d[_0x3c00ad])_0x5ab37a=(_0x1634a4<0x3?_0x1ebe12[_0x59c37b(0x238)](_0x4f2199,_0x5ab37a):_0x1634a4>0x3?_0x4f2199(_0xebeb19,_0x470997,_0x5ab37a):_0x4f2199(_0xebeb19,_0x470997))||_0x5ab37a;}return _0x1ebe12[_0x59c37b(0x239)](_0x1634a4,0x3)&&_0x5ab37a&&Object['defineProperty'](_0xebeb19,_0x470997,_0x5ab37a),_0x5ab37a;},__metadata=this&&this[a74_0xb2d391(0x244)]||function(_0x32bb1e,_0x30f8e5){const _0x13a327=a74_0xb2d391,_0x5626bc={'cNmKp':_0x13a327(0x212),'TCoHw':_0x13a327(0x21a)};if(typeof Reflect===_0x5626bc['cNmKp']&&typeof Reflect[_0x13a327(0x202)]===_0x5626bc[_0x13a327(0x205)])return Reflect['metadata'](_0x32bb1e,_0x30f8e5);},__param=this&&this['__param']||function(_0x5e7020,_0x4abfc2){return function(_0x2e207a,_0x4161c5){_0x4abfc2(_0x2e207a,_0x4161c5,_0x5e7020);};};Object['defineProperty'](exports,a74_0xb2d391(0x213),{'value':!![]}),exports['SalesService']=void 0x0;const common_1=require('@nestjs/common'),mongoose_1=require(a74_0xb2d391(0x1d1)),mongoose_2=require('mongoose'),inventory_service_1=require('../product/inventory.service'),sales_schema_1=require('./sales.schema'),purchases_service_1=require('../purchases/purchases.service'),customer_service_1=require('../customer/customer.service'),activity_service_1=require('../activity/activity.service'),do_logger_1=require(a74_0xb2d391(0x22c));let SalesService=class SalesService{constructor(_0x342ed6,_0x3be027,_0x355310,_0x55afc9,_0x413a54){const _0x24588c=a74_0xb2d391;this['inventoryService']=_0x342ed6,this['saleModel']=_0x3be027,this[_0x24588c(0x208)]=_0x355310,this['customerService']=_0x55afc9,this[_0x24588c(0x22e)]=_0x413a54,this['logger']=common_1[_0x24588c(0x1d7)];}async['doSell'](_0x3bf4c8,_0x34788d){const _0x3753c2=a74_0xb2d391,_0x3ab148={'joprq':function(_0x37dee8,_0x4d44e7){return _0x37dee8>=_0x4d44e7;},'arSGR':function(_0x18e239,_0x5226c4){return _0x18e239*_0x5226c4;},'hhXur':function(_0x179ca6,_0x39d61e){return _0x179ca6>_0x39d61e;},'gruDD':function(_0xac519e,_0x24e423){return _0xac519e+_0x24e423;},'dKXOD':'ERROR','VyDtP':'customer\x20bank'};let _0x4fc4ca=0x0,_0x55bbb3=0x0;try{for(const _0x3f452f of _0x3bf4c8['products']){_0x4fc4ca=_0x3f452f[_0x3753c2(0x1f5)],_0x3f452f[_0x3753c2(0x1fd)]=[];try{while(_0x3ab148['hhXur'](_0x4fc4ca,0x0)){await _0x123101(_0x3f452f,this[_0x3753c2(0x22e)]);}for(const _0x59cebf of _0x3f452f['breakdown']){_0x55bbb3=_0x3ab148['gruDD'](_0x55bbb3,_0x59cebf['total_profit']);}}catch(_0x223ea1){(0x0,do_logger_1['log'])(_0x3753c2(0x24b)+_0x223ea1,_0x3ab148[_0x3753c2(0x203)]);throw new common_1[(_0x3753c2(0x1cc))](_0x223ea1);}}_0x3bf4c8[_0x3753c2(0x206)]=_0x55bbb3,_0x3bf4c8['handler']=_0x34788d['user']['username'],_0x3bf4c8['totalAmount']=_0x3bf4c8['cash']+_0x3bf4c8[_0x3753c2(0x247)]+_0x3bf4c8[_0x3753c2(0x223)],_0x3bf4c8[_0x3753c2(0x1c5)]=_0x34788d[_0x3753c2(0x21b)]['location'],_0x3bf4c8[_0x3753c2(0x23a)]=new Date(_0x3bf4c8[_0x3753c2(0x23a)]);const _0x26ff82=await this[_0x3753c2(0x224)][_0x3753c2(0x245)](_0x3bf4c8);for(const _0x52992b of _0x26ff82[_0x3753c2(0x226)]){await this[_0x3753c2(0x248)]['deductStock'](_0x52992b['_id'],_0x52992b[_0x3753c2(0x1f5)],_0x34788d),await this['inventoryService']['addToSold'](_0x52992b['_id'],_0x52992b['quantity']);}return _0x3bf4c8[_0x3753c2(0x1e9)]&&_0x3bf4c8[_0x3753c2(0x1e9)]!==''&&await this[_0x3753c2(0x1dd)][_0x3753c2(0x201)](_0x3bf4c8['customer'],_0x26ff82[_0x3753c2(0x1ce)],_0x26ff82[_0x3753c2(0x1d0)]),await this['activityService']['logAction'](''+_0x34788d[_0x3753c2(0x21b)]['userId'],_0x34788d[_0x3753c2(0x21b)][_0x3753c2(0x21c)],'Made\x20Sales',_0x3753c2(0x1cb)+_0x26ff82['transactionId']),_0x26ff82[_0x3753c2(0x233)](_0x3ab148['VyDtP']);}catch(_0x96d582){(0x0,do_logger_1['log'])(_0x96d582,_0x3753c2(0x249));throw new common_1[(_0x3753c2(0x1e8))](_0x96d582);}async function _0x123101(_0x6e4a3b,_0x5622bc){const _0x45a4dc=_0x3753c2,_0x298ba9=await _0x5622bc[_0x45a4dc(0x1e7)](_0x6e4a3b[_0x45a4dc(0x1ce)],_0x34788d),_0xda4f60=_0x298ba9[_0x45a4dc(0x243)][_0x45a4dc(0x1f8)]((_0x1a7529,_0x17b7f6)=>_0x1a7529+(_0x17b7f6[_0x45a4dc(0x242)]||0x0),0x0),_0x237acf=_0x298ba9[_0x45a4dc(0x1f5)]-_0xda4f60;if(_0x3ab148['joprq'](_0x237acf,_0x4fc4ca)){const _0x511d2f={'orderBatch':_0x298ba9['_id'],'quantity':_0x4fc4ca,'costPrice':_0x298ba9['price'],'profit':_0x6e4a3b[_0x45a4dc(0x1df)]-_0x298ba9[_0x45a4dc(0x1df)],'total_profit':(_0x6e4a3b['price']-_0x298ba9[_0x45a4dc(0x1df)])*_0x4fc4ca};_0x6e4a3b[_0x45a4dc(0x1fd)][_0x45a4dc(0x20b)](_0x511d2f),_0x298ba9[_0x45a4dc(0x243)][_0x45a4dc(0x20b)]({'amount':_0x4fc4ca,'price':_0x6e4a3b['price']}),_0x4fc4ca=0x0,await _0x298ba9['save']();}else{const _0x3630fe={'orderBatch':_0x298ba9[_0x45a4dc(0x1ce)],'quantity':_0x237acf,'costPrice':_0x298ba9[_0x45a4dc(0x1df)],'profit':_0x6e4a3b[_0x45a4dc(0x1df)]-_0x298ba9['price'],'total_profit':_0x3ab148[_0x45a4dc(0x1f4)](_0x6e4a3b['price']-_0x298ba9['price'],_0x237acf)};_0x6e4a3b['breakdown']=_0x6e4a3b['breakdown'][_0x45a4dc(0x20b)](_0x3630fe),_0x298ba9['sold'][_0x45a4dc(0x20b)]({'amount':_0x237acf,'price':_0x6e4a3b[_0x45a4dc(0x1df)]}),_0x4fc4ca=_0x4fc4ca-_0x237acf,await _0x298ba9[_0x45a4dc(0x1f7)]();}}}async['getSingleProductSaleData'](_0x49c989,_0x1a322f,_0x375959){const _0x2dcbd1=a74_0xb2d391,_0x454b4c={'ryRXq':_0x2dcbd1(0x1dc),'pLPRm':function(_0x3bf5c8,_0xdf7a2e){return _0x3bf5c8+_0xdf7a2e;},'Aoowc':_0x2dcbd1(0x20d),'pGars':_0x2dcbd1(0x1c3),'dmCdC':function(_0x20118c,_0x10eb62){return _0x20118c-_0x10eb62;},'EhTNU':'First\x20Quarter','SLzoM':_0x2dcbd1(0x230)},{filter:filter='{}'}=_0x1a322f,_0x467123=JSON['parse'](filter),_0x3eb3a0=new Date();let _0x5f33aa,_0x4c7302,_0x397906;switch(_0x467123[_0x2dcbd1(0x21e)]){case _0x2dcbd1(0x22f):_0x5f33aa=new Date(_0x3eb3a0[_0x2dcbd1(0x1d4)](0x0,0x0,0x0,0x0)),_0x4c7302=new Date(_0x3eb3a0['setHours'](0x17,0x3b,0x3b,0x3e7)),_0x397906={'for':{'$add':[{'$divide':[{'$subtract':[{'$hour':'$transactionDate'},{'$mod':[{'$hour':_0x454b4c['ryRXq']},0x2]}]},0x2]},0x1]}};break;case'This\x20Week':_0x5f33aa=new Date(_0x3eb3a0[_0x2dcbd1(0x24a)](_0x3eb3a0[_0x2dcbd1(0x22d)]()-_0x3eb3a0[_0x2dcbd1(0x235)]())),_0x4c7302=new Date(_0x3eb3a0[_0x2dcbd1(0x24a)](_0x454b4c[_0x2dcbd1(0x1c8)](_0x3eb3a0['getDate']()-_0x3eb3a0[_0x2dcbd1(0x235)](),0x6))),_0x397906={'for':{'$dayOfWeek':_0x454b4c['ryRXq']}};break;case _0x454b4c['Aoowc']:_0x5f33aa=new Date(),_0x5f33aa['setDate'](_0x5f33aa[_0x2dcbd1(0x22d)]()-0x6),_0x5f33aa['setHours'](0x0,0x0,0x0,0x0),_0x4c7302=new Date(),_0x4c7302['setHours'](0x17,0x3b,0x3b,0x3e7),_0x397906={'for':{'$subtract':[{'$add':[{'$dateDiff':{'startDate':_0x5f33aa,'endDate':_0x454b4c[_0x2dcbd1(0x214)],'unit':_0x454b4c[_0x2dcbd1(0x21d)]}},0x1]},0x1]}};break;case _0x2dcbd1(0x1f6):_0x5f33aa=new Date(_0x3eb3a0['setDate'](_0x454b4c[_0x2dcbd1(0x1fe)](_0x3eb3a0[_0x2dcbd1(0x22d)](),_0x3eb3a0['getDay']())-0x7)),_0x4c7302=new Date(_0x3eb3a0[_0x2dcbd1(0x24a)](_0x3eb3a0['getDate']()-_0x3eb3a0[_0x2dcbd1(0x235)]()-0x1)),_0x397906={'for':{'$dayOfWeek':_0x2dcbd1(0x1dc)}};break;case _0x2dcbd1(0x23b):_0x5f33aa=new Date(_0x3eb3a0['getFullYear'](),_0x3eb3a0[_0x2dcbd1(0x1e2)](),0x1),_0x4c7302=new Date(_0x3eb3a0[_0x2dcbd1(0x1e5)](),_0x3eb3a0[_0x2dcbd1(0x1e2)]()+0x1,0x0),_0x397906={'for':{'$dayOfMonth':_0x2dcbd1(0x1dc)}};break;case _0x2dcbd1(0x1f2):_0x5f33aa=new Date(_0x3eb3a0['getFullYear'](),_0x3eb3a0[_0x2dcbd1(0x1e2)]()-0x1,0x1),_0x4c7302=new Date(_0x3eb3a0[_0x2dcbd1(0x1e5)](),_0x3eb3a0[_0x2dcbd1(0x1e2)](),0x0),_0x397906={'for':{'$dayOfMonth':_0x454b4c['ryRXq']}};break;case _0x454b4c['EhTNU']:_0x5f33aa=new Date(_0x3eb3a0['getFullYear'](),0x0,0x1),_0x4c7302=new Date(_0x3eb3a0['getFullYear'](),0x3,0x0),_0x397906={'for':{'$month':_0x454b4c['ryRXq']}};break;case'Second\x20Quarter':_0x5f33aa=new Date(_0x3eb3a0['getFullYear'](),0x3,0x1),_0x4c7302=new Date(_0x3eb3a0[_0x2dcbd1(0x1e5)](),0x6,0x0),_0x397906={'for':{'$month':_0x454b4c['ryRXq']}};break;case _0x2dcbd1(0x1bf):_0x5f33aa=new Date(_0x3eb3a0[_0x2dcbd1(0x1e5)](),0x6,0x1),_0x4c7302=new Date(_0x3eb3a0['getFullYear'](),0x9,0x0),_0x397906={'for':{'$month':'$transactionDate'}};break;case'Fourth\x20Quarter':_0x5f33aa=new Date(_0x3eb3a0[_0x2dcbd1(0x1e5)](),0x9,0x1),_0x4c7302=new Date(_0x3eb3a0['getFullYear'](),0xc,0x0),_0x397906={'for':{'$month':'$transactionDate'}};break;case _0x2dcbd1(0x1fb):_0x5f33aa=new Date(_0x3eb3a0[_0x2dcbd1(0x1e5)](),0x0,0x1),_0x4c7302=new Date(_0x3eb3a0[_0x2dcbd1(0x1e5)](),0xb,0x1f),_0x397906={'for':{'$month':_0x2dcbd1(0x1dc)}};break;default:throw new Error(_0x454b4c[_0x2dcbd1(0x1c4)]);}try{const _0x276b78=await this[_0x2dcbd1(0x224)]['aggregate']([{'$match':{'products._id':_0x49c989,'transactionDate':{'$gte':_0x5f33aa,'$lte':_0x4c7302},'location':_0x375959[_0x2dcbd1(0x21b)]['location']}},{'$unwind':_0x2dcbd1(0x23d)},{'$group':{'_id':_0x397906,'totalSales':{'$sum':'$products.total'}}},{'$sort':{'_id':0x1}},{'$project':{'_id':0x0,'for':'$_id.for','totalSales':0x1}}]);return _0x276b78;}catch(_0x14dfe4){(0x0,do_logger_1['log'])(_0x2dcbd1(0x1c9)+_0x14dfe4,'ERROR');throw new common_1[(_0x2dcbd1(0x1cc))](_0x14dfe4);}}async['doSearch'](_0x58fc12,_0x449901){const _0x105c5a=a74_0xb2d391,_0x555b79={'kZxME':_0x105c5a(0x249)},_0x8d120d={},_0x559957={'$text':{'$search':_0x58fc12}};try{return await this['saleModel'][_0x105c5a(0x1c7)]({..._0x559957,'location':_0x449901['user'][_0x105c5a(0x1c5)]})[_0x105c5a(0x1fc)]();}catch(_0x230fd7){(0x0,do_logger_1[_0x105c5a(0x23f)])(_0x105c5a(0x216)+_0x230fd7,_0x555b79['kZxME']);throw new common_1[(_0x105c5a(0x1cc))](_0x230fd7);}}async[a74_0xb2d391(0x227)](_0x521250,_0x49b777){const _0x5100fa=a74_0xb2d391,_0xec5c1b={'HvKZW':_0x5100fa(0x212),'luKKH':function(_0x5bb650,_0x2575ae){return _0x5bb650===_0x2575ae;},'vzEvK':'$discount','GSDDN':_0x5100fa(0x23e),'ggNqm':_0x5100fa(0x1ea),'rxQOm':_0x5100fa(0x219)},{filter:filter='{}',sort:sort='{}',skip:skip=0x0,select:select='',limit:limit=0xa}=_0x521250,_0x261903=JSON['parse'](filter),_0x2c654f=JSON['parse'](sort);try{const _0x3c0751=new Date(_0x521250[_0x5100fa(0x21f)]);_0x3c0751[_0x5100fa(0x1d4)](0x0,0x0,0x0,0x0);const _0x2f1db4=new Date(_0x521250['endDate']);_0x2f1db4[_0x5100fa(0x1d4)](0x17,0x3b,0x3b,0x3e7),_0x261903['transactionDate']={'$gte':_0x3c0751,'$lte':_0x2f1db4};_0x49b777['user'][_0x5100fa(0x20c)]===_0x5100fa(0x1fa)&&(_0x261903[_0x5100fa(0x215)]=_0x49b777[_0x5100fa(0x21b)][_0x5100fa(0x21c)]);_0x49b777['user']['role']===_0x5100fa(0x241)&&(_0x261903['handler']=_0x49b777['user'][_0x5100fa(0x21c)]);_0x261903&&typeof _0x261903===_0xec5c1b['HvKZW']&&'barcodeId'in _0x261903&&(_0x521250[_0x5100fa(0x1ed)]=0x0,delete _0x261903[_0x5100fa(0x23a)]);_0x261903['handler']===''&&delete _0x261903['handler'];_0xec5c1b['luKKH'](_0x261903['paymentMethod'],'')&&delete _0x261903[_0x5100fa(0x229)];const _0x381bc5=await this[_0x5100fa(0x224)][_0x5100fa(0x1eb)]([{'$match':{..._0x261903,'location':_0x49b777['user'][_0x5100fa(0x1c5)]}},{'$group':{'_id':null,'totalAmount':{'$sum':'$totalAmount'},'totalDiscount':{'$sum':_0xec5c1b[_0x5100fa(0x1d6)]},'totalTransfer':{'$sum':_0xec5c1b['GSDDN']},'totalCard':{'$sum':_0xec5c1b['ggNqm']},'totalCash':{'$sum':'$cash'},'totalProfit':{'$sum':_0x5100fa(0x1de)}}}]),_0x23903b=_0x381bc5['length']>0x0?_0x381bc5[0x0]:{'totalAmount':0x0,'totalDiscount':0x0,'totalTransfer':0x0,'totalCard':0x0,'totalCash':0x0,'totalProfit':0x0},_0x13a049=await this[_0x5100fa(0x224)][_0x5100fa(0x1c7)]({..._0x261903,'location':_0x49b777['user'][_0x5100fa(0x1c5)]})['sort'](_0x2c654f)[_0x5100fa(0x1ed)](Number(skip))['limit'](Number(limit))['select'](select)[_0x5100fa(0x233)](_0xec5c1b[_0x5100fa(0x22a)])['exec'](),_0x1a0524=await this[_0x5100fa(0x224)]['countDocuments']({..._0x261903,'location':_0x49b777['user']['location']}),_0x3ea8af=await this[_0x5100fa(0x224)][_0x5100fa(0x1c7)]({'transactionDate':{'$gte':_0x3c0751,'$lte':_0x2f1db4},'location':_0x49b777[_0x5100fa(0x21b)][_0x5100fa(0x1c5)]}),_0x6a0046=new Set();_0x3ea8af[_0x5100fa(0x231)](_0xd211d9=>_0x6a0046['add'](_0xd211d9['handler']));const _0x5abd95=Array[_0x5100fa(0x240)](_0x6a0046);return{'sales':_0x13a049,'handlers':_0x5abd95,'totalDocuments':_0x1a0524,'summary':_0x23903b};}catch(_0x4f77e8){(0x0,do_logger_1[_0x5100fa(0x23f)])(_0x4f77e8,'ERROR');throw new common_1[(_0x5100fa(0x1e8))](_0x4f77e8);}}async['findOne'](_0x439011){const _0x11de68=a74_0xb2d391,_0x113152={'YiOvi':_0x11de68(0x249)};try{return await this['saleModel'][_0x11de68(0x1e1)](_0x439011)[_0x11de68(0x233)](_0x11de68(0x219))[_0x11de68(0x1fc)]();}catch(_0x44bf07){(0x0,do_logger_1['log'])('Error\x20finding\x20one\x20'+_0x44bf07,_0x113152['YiOvi']);throw new common_1['BadRequestException'](_0x44bf07);}}async['update'](_0x430af1,_0x3e9f91,_0x58c724){const _0x498640=a74_0xb2d391,_0x5a7f02={'IMYmi':_0x498640(0x204)};try{const _0x187701=await this['saleModel'][_0x498640(0x1e1)](_0x430af1);for(const _0x2b9670 in _0x3e9f91){_0x3e9f91['hasOwnProperty'](_0x2b9670)&&_0x187701[_0x2b9670]!==undefined&&(_0x187701[_0x2b9670]=_0x3e9f91[_0x2b9670]);}const _0x5c15a0=await _0x187701['save']();return await this['activityService'][_0x498640(0x20a)](''+_0x58c724[_0x498640(0x21b)][_0x498640(0x1bd)],_0x58c724['user']['username'],_0x5a7f02['IMYmi'],_0x498640(0x1ff)+_0x5c15a0['transactionId']+_0x498640(0x1da)+JSON[_0x498640(0x1ec)](_0x3e9f91)),_0x5c15a0;}catch(_0x3ca309){(0x0,do_logger_1[_0x498640(0x23f)])('Error\x20updaing\x20one\x20'+_0x3ca309,_0x498640(0x249));throw new common_1[(_0x498640(0x1cc))](_0x3ca309);}}async['return'](_0x257be1,_0x4007d1,_0xd80878){const _0x478ac2=a74_0xb2d391,_0x599dec={'nYDsq':function(_0x4c665a,_0x47a978){return _0x4c665a!==_0x47a978;},'iDoDR':function(_0x637b04,_0x189f6f){return _0x637b04>_0x189f6f;},'RqwaL':function(_0x40dd89,_0xe76161){return _0x40dd89<=_0xe76161;},'bYIJV':function(_0x59c319,_0x3d9456){return _0x59c319*_0x3d9456;}};try{if(!_0x4007d1['handler'])for(const _0xe26158 of _0x4007d1['returns']){_0xe26158[_0x478ac2(0x215)]=_0xd80878['user'][_0x478ac2(0x21c)];}else for(const _0x1feff of _0x4007d1[_0x478ac2(0x234)]){_0x1feff[_0x478ac2(0x215)]=_0x4007d1['handler'];}const _0x7d6ca1=await this[_0x478ac2(0x224)]['findOne']({'_id':_0x257be1});_0x7d6ca1['returns']=_0x7d6ca1['returns']['concat'](_0x4007d1['returns']);let _0x5bd484=_0x4007d1[_0x478ac2(0x234)],_0x1ac9de=_0x7d6ca1['products'];for(const _0x465372 of _0x5bd484){const _0x162f1e=_0x1ac9de[_0x478ac2(0x209)](_0xef7eed=>_0xef7eed['_id'][_0x478ac2(0x1e3)]()===_0x465372[_0x478ac2(0x1f3)][_0x478ac2(0x1e3)]());if(_0x599dec[_0x478ac2(0x23c)](_0x162f1e,-0x1)){let _0x4e4cb1=_0x465372['quantity'];while(_0x599dec['iDoDR'](_0x4e4cb1,0x0)){let _0x34b648=_0x465372[_0x478ac2(0x20e)][0x0];_0x599dec['RqwaL'](_0x34b648[_0x478ac2(0x1f5)],_0x4e4cb1)?(await this[_0x478ac2(0x22e)]['editSoldQuantity'](_0x34b648['orderBatch'],_0x34b648['quantity'],_0x1ac9de[_0x162f1e][_0x478ac2(0x1df)]),_0x465372['batches'][_0x478ac2(0x1cf)](0x0,0x1),_0x4e4cb1-=_0x34b648[_0x478ac2(0x1f5)]):(await this['purchaseService'][_0x478ac2(0x1f0)](_0x34b648[_0x478ac2(0x217)],_0x4e4cb1,_0x1ac9de[_0x162f1e][_0x478ac2(0x1df)]),_0x465372[_0x478ac2(0x20e)][0x0]['quantity']-=_0x4e4cb1,_0x465372['batches'][0x0]['total_profit']=_0x599dec['bYIJV'](_0x465372['batches'][0x0]['quantity'],_0x465372['batches'][0x0][_0x478ac2(0x206)]),_0x4e4cb1=0x0);}_0x1ac9de[_0x162f1e]['breakdown']=_0x465372[_0x478ac2(0x20e)],_0x1ac9de[_0x162f1e]['quantity']-=_0x465372['quantity'],_0x1ac9de[_0x162f1e][_0x478ac2(0x200)]=_0x1ac9de[_0x162f1e][_0x478ac2(0x1f5)]*_0x1ac9de[_0x162f1e][_0x478ac2(0x1df)],_0x1ac9de[_0x162f1e][_0x478ac2(0x1f5)]<0x1&&_0x1ac9de['splice'](_0x162f1e,0x1);}}_0x7d6ca1[_0x478ac2(0x1d0)]=_0x1ac9de[_0x478ac2(0x1f8)]((_0x95d531,_0x171dee)=>_0x95d531+_0x171dee['total'],0x0);let _0x462135=0x0;for(const _0x443a68 of _0x7d6ca1[_0x478ac2(0x226)]){for(const _0x5342e2 of _0x443a68[_0x478ac2(0x1fd)]){_0x462135=_0x462135+_0x5342e2[_0x478ac2(0x1e4)];}}_0x7d6ca1[_0x478ac2(0x206)]=_0x462135,await _0x7d6ca1['save']();for(const _0x15df4e of _0x4007d1[_0x478ac2(0x234)]){await this[_0x478ac2(0x248)]['restockProduct'](_0x15df4e[_0x478ac2(0x1f3)],_0x15df4e['quantity']),await this[_0x478ac2(0x248)]['deductFromSold'](_0x15df4e[_0x478ac2(0x1ce)],_0x15df4e['quantity']);}return await this['activityService']['logAction'](''+_0xd80878['user']['userId'],_0xd80878['user'][_0x478ac2(0x21c)],_0x478ac2(0x228),'Made\x20returns\x20on\x20transaction\x20with\x20Id\x20'+_0x4007d1['transactionId']),_0x7d6ca1;}catch(_0x1c781e){(0x0,do_logger_1['log'])('Error\x20returnig\x20one\x20'+_0x1c781e,'ERROR');throw new common_1['BadRequestException'](_0x1c781e);}}async[a74_0xb2d391(0x221)](_0x46ba64,_0x235ad6){const _0x40f3d2=a74_0xb2d391,_0x540a7f={'ujLpG':_0x40f3d2(0x211)};try{const _0x59b9fe=await this['saleModel']['findByIdAndDelete'](_0x46ba64)[_0x40f3d2(0x1fc)]();return await this[_0x40f3d2(0x208)][_0x40f3d2(0x20a)](''+_0x235ad6[_0x40f3d2(0x21b)][_0x40f3d2(0x1bd)],_0x235ad6[_0x40f3d2(0x21b)]['username'],_0x540a7f['ujLpG'],_0x40f3d2(0x218)+_0x46ba64),_0x59b9fe;}catch(_0x4da140){(0x0,do_logger_1[_0x40f3d2(0x23f)])(_0x40f3d2(0x1cd)+_0x4da140,_0x40f3d2(0x249));throw new common_1['BadRequestException'](_0x4da140);}}async['getDashboardData'](_0xb4a839,_0x2e725d,_0x3c8864,_0x58e7c8){const _0x37ced1=a74_0xb2d391,_0x170d32={'WJSCe':'$products'};!_0x2e725d&&(_0x2e725d=new Date(),_0x2e725d['setHours'](0x0,0x0,0x0,0x0));!_0x3c8864&&(_0x3c8864=new Date(),_0x3c8864['setHours'](0x17,0x3b,0x3b,0x3e7));const _0xdc8244=await this['saleModel']['aggregate']([{'$unwind':_0x170d32['WJSCe']},{'$match':{'products._id':_0xb4a839,'createdAt':{'$gte':new Date(_0x2e725d),'$lte':new Date(_0x3c8864)},'location':_0x58e7c8[_0x37ced1(0x21b)][_0x37ced1(0x1c5)]}},{'$group':{'_id':null,'totalAmount':{'$sum':_0x37ced1(0x1d8)},'totalPrice':{'$sum':{'$multiply':['$products.price',_0x37ced1(0x1d8)]}},'sales_by_date':{'$push':{'date':'$createdAt','amount':_0x37ced1(0x1d8)}}}}]);return _0xdc8244;}async[a74_0xb2d391(0x1c1)](_0x5281f2){}['formatPhoneNumber'](_0x2ff7ea){const _0x36068d=a74_0xb2d391,_0x8ce7b3=_0x2ff7ea[_0x36068d(0x1c0)](/\D/g,'');if(_0x8ce7b3[_0x36068d(0x222)]('0'))return _0x36068d(0x1ef)+_0x8ce7b3['substring'](0x1)+'@c.us';else{if(_0x8ce7b3[_0x36068d(0x222)]('234'))return _0x8ce7b3+'@c.us';else throw new Error('Invalid\x20Nigerian\x20phone\x20number');}}};exports[a74_0xb2d391(0x1e0)]=SalesService,exports['SalesService']=SalesService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,common_1['Inject'])((0x0,common_1['forwardRef'])(()=>inventory_service_1['InventoryService']))),__param(0x1,(0x0,mongoose_1[a74_0xb2d391(0x1d2)])(sales_schema_1[a74_0xb2d391(0x246)]['name'])),__metadata('design:paramtypes',[inventory_service_1['InventoryService'],mongoose_2['Model'],activity_service_1[a74_0xb2d391(0x1c2)],customer_service_1[a74_0xb2d391(0x1d3)],purchases_service_1['PurchasesService']])],SalesService);function a74_0x2699(){const _0x3acd22=['$products.quantity','1386807iHPwPQ','\x20with\x20','42tbabdh','$transactionDate','customerService','$profit','price','SalesService','findById','getMonth','toString','total_profit','getFullYear','7931YSBqEk','findFirstUnsoldPurchase','InternalServerErrorException','customer','$card','aggregate','stringify','skip','bAVWB','234','editSoldQuantity','__decorate','Last\x20Month','productId','arSGR','quantity','Last\x20Week','save','reduce','decorate','cashier','This\x20Year','exec','breakdown','dmCdC','Updated\x20sale\x20with\x20transaction\x20Id\x20','total','addOrder','metadata','dKXOD','Update\x20Sales','TCoHw','profit','8067839ypflfl','activityService','findIndex','logAction','push','role','Last\x207\x20Days','batches','4288689lfhkdu','4qzcinK','Deleted\x20Transaction','object','__esModule','ryRXq','handler','Error\x20searching\x20','orderBatch','Made\x20returns\x20on\x20transaction\x20with\x20Id\x20','customer\x20bank','function','user','username','pGars','sorter','startDate','219813maayTP','delete','startsWith','transfer','saleModel','380151rvARwF','products','findAll','Made\x20Returns','paymentMethod','rxQOm','151535HTOzhH','../do_logger','getDate','purchaseService','Today','Invalid\x20option','forEach','12gjZsEF','populate','returns','getDay','length','2280UMBxrT','QqDpw','uXPvU','transactionDate','This\x20Month','nYDsq','$products','$transfer','log','from','staff','amount','sold','__metadata','create','Sale','card','inventoryService','ERROR','setDate','Error\x20crating\x20sell\x20brakedown\x20','userId','getOwnPropertyDescriptor','Third\x20Quarter','replace','getSalesData','ActivityService','day','SLzoM','location','20qSXieP','find','pLPRm','Error\x20gettig\x20single\x20sale\x20data\x20','pKIbS','Transaction\x20Id\x20','BadRequestException','Error\x20deleting\x20one\x20','_id','splice','totalAmount','@nestjs/mongoose','InjectModel','CustomerService','setHours','2nfURfT','vzEvK','Logger'];a74_0x2699=function(){return _0x3acd22;};return a74_0x2699();}